# 基于miniprogram-ci构建的小程序自动化服务需求文档

  

## 1. 项目概述

  

### 1.1 项目背景

在小程序的开发和发布流程中，经常会有以下问题：

1. 开发人员需要手动登录小程序管理后台，上传代码并发布，效率低下

2. 开发过程中修改一些样式和布局问题时，需要经常给测试人员和产品经理查看，要生成预览版本然后再截图预览二维码发到个人或者群里面，很麻烦，效率低下

3. 每次上传小程序都需要重新写一遍更新说明，效率低下

4. 缺乏统一的构建标准和流程管控

5. 无法追溯历史构建记录和问题定位

  

### 1.2 项目目标

本项目旨在构建一个基于miniprogram-ci的小程序自动化服务平台，实现小程序代码的自动化构建、上传和预览，提升开发效率，降低人工操作成本。

  

### 1.3 核心价值

- **自动化**：实现代码提交到发布的全流程自动化

- **可视化**：提供Web管理界面，便捷管理多个小程序

- **标准化**：统一构建流程，确保发布质量

- **可追溯**：完整的构建历史和日志记录

- **高效率**：减少90%的手工操作时间

  

### 1.4 目标用户

- **开发人员**：快速构建和部署小程序

- **测试人员**：便捷获取预览版本进行测试

- **产品经理**：实时查看开发进度和效果

- **运维人员**：监控构建状态和系统运行情况

- **管理人员**：掌控项目发布流程和质量

  

## 2. 技术架构

  

### 2.1 系统架构

```

┌─────────────────────────────────────────────────────────┐

│                      前端展示层                           │

│         Vue3 + TypeScript + Vite + VbenAdmin            │

└─────────────────────────────────────────────────────────┘

                            ↕

┌─────────────────────────────────────────────────────────┐

│                      API网关层                           │

│                    Nginx + JWT认证                       │

└─────────────────────────────────────────────────────────┘

                            ↕

┌─────────────────────────────────────────────────────────┐

│                      业务服务层                          │

│                  NestJS + Prisma ORM                    │

├─────────────────────────────────────────────────────────┤

│   用户服务 │ 角色服务 │ 小程序服务 │ 构建服务 │ 通知服务    │

└─────────────────────────────────────────────────────────┘

                            ↕

┌─────────────────────────────────────────────────────────┐

│                      基础设施层                          │

│     MySQL │ Redis │ MinIO │ RabbitMQ │ Docker          │

└─────────────────────────────────────────────────────────┘

```

  

### 2.2 技术栈

  

#### 2.2.1 服务端

- **miniprogram-ci**：微信官方提供的小程序CI工具，用于构建和上传小程序代码

- **NestJS**：企业级Node.js框架，用于构建后端服务

- **MySQL 8.0**：关系型数据库，存储核心业务数据

- **Redis 6.0**：缓存数据库，用于缓存和队列管理

- **Prisma**：现代化ORM框架，用于数据库操作和迁移

- **Shell/Node脚本**：用于编写自动化脚本

- **Docker**：容器化部署

- **PM2**：进程管理工具

  

#### 2.2.2 客户端

- **TypeScript 5.0**：类型安全的JavaScript超集

- **Vue 3.3**：渐进式JavaScript框架

- **Vite 4.0**：新一代前端构建工具

- **VbenAdmin**：基于Vue3的中后台管理系统模板

- **Element Plus**：Vue3组件库

- **Axios**：HTTP请求库

- **ECharts**：数据可视化库

  

## 3. 功能需求

  

### 3.1 认证与授权模块

  

#### 3.1.1 登录认证

**功能描述**：提供安全的用户身份认证机制

  

**认证方式**：

- 用户名密码登录

- JWT Token认证机制

- Token有效期：7天（可配置）

- 支持Token刷新机制

- 登录失败锁定策略：连续5次失败锁定30分钟

  

**接口定义**：

- **URL**: POST /api/v1/auth/login

- **请求参数**：

  

| 字段       | 类型     | 必填  | 描述                   | 示例         |
| -------- | ------ | --- | -------------------- | ---------- |
| username | string | 是   | 用户名，4-20位字母数字        | "admin"    |
| password | string | 是   | 密码，8-20位，需包含大小写字母和数字 | "Admin123" |
| captcha  | string | 否   | 验证码，多次失败后需要          | "a3f5"     |

  

**响应示例**：

```json

{

  "code": 200,

  "message": "登录成功",

  "data": {

    "token": "eyJhbGciOiJIUzI1NiIs...",

    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",

    "expiresIn": 604800,

    "userInfo": {

      "id": 1,

      "username": "admin",

      "role": "administrator",

      "permissions": ["*"]

    }

  }

}

```

  

#### 3.1.2 权限控制

**设计模式**：基于RBAC（Role-Based Access Control）模型

- 权限粒度：功能级别 + 数据级别

- 支持权限继承和组合

- 动态权限配置

  

**权限定义**：

```javascript

permissions = {

  "user": ["read", "create", "update", "delete"],

  "role": ["read", "create", "update", "delete"],

  "miniprogram": ["read", "create", "update", "delete", "upload", "preview"],

  "build": ["read", "cancel", "retry"],

  "system": ["config", "monitor", "audit"]

}

```

  

### 3.2 用户管理模块

  

#### 3.2.1 用户列表

**功能描述**：分页查询所有用户信息，支持筛选和搜索

  

**接口定义**：

- **URL**: GET /api/v1/users

- **权限**: user:read

- **请求参数**：

  

| 字段       | 类型     | 必填  | 描述              | 示例      |
| -------- | ------ | --- | --------------- | ------- |
| page     | number | 否   | 页码，默认1          | 1       |
| pageSize | number | 否   | 每页数量，默认10，最大100 | 10      |
| keyword  | string | 否   | 搜索关键词（用户名/邮箱）   | "admin" |
| status   | number | 否   | 状态筛选            | 1       |
| roleId   | number | 否   | 角色ID筛选          | 2       |

  

**响应字段**：

  

| 字段            | 类型       | 描述           |     |
| ------------- | -------- | ------------ | --- |
| id            | number   | 用户ID         |     |
| username      | string   | 用户名          |     |
| email         | string   | 邮箱地址         |     |
| phone         | string   | 手机号码         |     |
| realName      | string   | 真实姓名         |     |
| avatar        | string   | 头像URL        |     |
| roleId        | number   | 角色ID         |     |
| roleName      | string   | 角色名称         |     |
| status        | number   | 状态：0-禁用 1-启用 |     |
| lastLoginTime | datetime | 最后登录时间       |     |
| lastLoginIp   | string   | 最后登录IP       |     |
| createTime    | datetime | 创建时间         |     |
| updateTime    | datetime | 更新时间         |     |
| creator       | string   | 创建人          |     |

  

#### 3.2.2 新增用户

**功能描述**：创建新的系统用户账号

  

**接口定义**：

- **URL**: POST /api/v1/users

- **权限**: user:create

- **请求参数**：

  

| 字段 | 类型 | 必填 | 描述 | 验证规则 |
| --- | --- | --- | --- | --- |
| username | string | 是 | 用户名 | 4-20位，字母开头，字母数字下划线 |
| password | string | 是 | 密码 | 8-20位，包含大小写字母和数字 |
| email | string | 是 | 邮箱 | 有效邮箱格式 |
| phone | string | 否 | 手机号 | 11位手机号 |
| realName | string | 否 | 真实姓名 | 2-20位中文或英文 |
| roleId | number | 是 | 角色ID | 必须存在的角色 |
| status | number | 否 | 状态 | 默认1（启用） |
  

#### 3.2.3 编辑用户

**功能描述**：修改用户信息

  

**接口定义**：

- **URL**: PUT /api/v1/users/{id}

- **权限**: user:update

- **请求参数**：

  

| 字段 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| id | number | 是 | 用户ID |
| email | string | 否 | 邮箱 |
| phone | string | 否 | 手机号 |
| realName | string | 否 | 真实姓名 |
| roleId | number | 否 | 角色ID |
| status | number | 否 | 状态 |
| password | string | 否 | 新密码（需要二次验证） |
  

#### 3.2.4 删除用户

**功能描述**：软删除用户账号

  

**接口定义**：

- **URL**: DELETE /api/v1/users/{id}

- **权限**: user:delete

- **业务规则**：

  - 不能删除当前登录用户

  - 不能删除超级管理员

  - 删除后相关构建历史保留，显示"已删除用户"

  

### 3.3 角色管理模块

  

#### 3.3.1 角色列表

**功能描述**：查询所有角色信息及权限配置

  

**接口定义**：

- **URL**: GET /api/v1/roles

- **权限**: role:read

- **响应字段**：

  

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| id | number | 角色ID |
| name | string | 角色名称 |
| code | string | 角色代码 |
| description | string | 角色描述 |
| status | number | 状态：0-禁用 1-启用 |
| permissions | array | 权限列表 |
| userCount | number | 用户数量 |
| isSystem | boolean | 是否系统角色（不可删除） |
| createTime | datetime | 创建时间 |
| updateTime | datetime | 更新时间 |
  

#### 3.3.2 新增角色

**功能描述**：创建新的角色

  

**接口定义**：

- **URL**: POST /api/v1/roles

- **权限**: role:create

- **请求参数**：

  

| 字段 | 类型 | 必填 | 描述 | 验证规则 |
| --- | --- | --- | --- | --- |
| name | string | 是 | 角色名称 | 2-20位 |
| code | string | 是 | 角色代码 | 2-20位，字母数字下划线 |
| description | string | 否 | 角色描述 | 最多200字符 |
| permissions | array | 是 | 权限列表 | 至少选择一个权限 |
| status | number | 否 | 状态 | 默认1 |
  

#### 3.3.3 编辑角色

**功能描述**：修改角色信息和权限

  

**接口定义**：

- **URL**: PUT /api/v1/roles/{id}

- **权限**: role:update

- **业务规则**：

  - 系统角色只能修改权限，不能修改名称和代码

  - 修改权限后，相关用户需要重新登录生效

  

#### 3.3.4 删除角色

**功能描述**：删除角色

  

**接口定义**：

- **URL**: DELETE /api/v1/roles/{id}

- **权限**: role:delete

- **业务规则**：

  - 系统角色不可删除

  - 有关联用户的角色不可删除

  

### 3.4 小程序管理模块

  

#### 3.4.1 小程序列表

**功能描述**：分页查询所有小程序配置信息

  

**接口定义**：

- **URL**: GET /api/v1/miniprograms

- **权限**: miniprogram:read

- **响应字段**：

  

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| id | number | 小程序ID |
| name | string | 小程序名称 |
| appId | string | 小程序AppID |
| appType | string | 类型：uniapp-uni-app项目 native-原生小程序 |
| gitUrl | string | Git仓库地址 |
| branch | string | 默认分支 |
| version | string | 当前版本号 |
| lastBuildTime | datetime | 最后构建时间 |
| lastBuildStatus | string | 最后构建状态 |
| lastBuildUser | string | 最后构建人 |
| autoBuild | boolean | 是否自动构建 |
| webhookUrl | string | Webhook地址 |
| notify | boolean | 是否开启通知 |
| status | number | 状态：0-停用 1-启用 |
| createTime | datetime | 创建时间 |
| updateTime | datetime | 更新时间 |
  

#### 3.4.2 新增小程序

**功能描述**：添加新的小程序配置

  

**接口定义**：

- **URL**: POST /api/v1/miniprograms

- **权限**: miniprogram:create

- **请求参数**：

  

| 字段             | 类型          | 必填  | 描述        | 验证规则                             |     |
| -------------- | ----------- | --- | --------- | -------------------------------- | --- |
| **基础信息**       |             |     |           |                                  |     |
| name           | string      | 是   | 小程序名称     | 2-50个字符                          |     |
| appId          | string      | 是   | 小程序AppID  | 有效的AppID格式                       |     |
| privateKey     | file/string | 是   | 小程序私钥     | .key文件或base64字符串                 |     |
| appType        | string      | 是   | 项目类型      | uniapp/native                    |     |
| **Git配置**      |             |     |           |                                  |     |
| gitUrl         | string      | 是   | Git仓库地址   | 有效的Git URL                       |     |
| branch         | string      | 是   | 默认分支      | 默认master                         |     |
| gitAuthType    | string      | 是   | 认证方式      | ssh/https/token                  |     |
| gitCredential  | string      | 否   | 认证凭据      | 根据认证方式提供                         |     |
| **构建配置**       |             |     |           |                                  |     |
| install        | boolean     | 是   | 是否安装依赖    | 默认true                           |     |
| installCommand | string      | 否   | 安装命令      | 默认npm install                    |     |
| buildCommand   | string      | 否   | 构建命令      | uni-app默认npm run build:mp-weixin |     |
| outputPath     | string      | 否   | 输出目录      | uni-app默认dist/build/mp-weixin    |     |
| npm            | boolean     | 是   | 启用npm构建   | 默认false                          |     |
| autoBuild      | boolean     | 是   | 自动构建      | 默认false                          |     |
| buildTimeout   | number      | 否   | 构建超时(分钟)  | 默认30                             |     |
| **上传配置**       |             |     |           |                                  |     |
| version        | string      | 否   | 初始版本号     | 默认1.0.0                          |     |
| versionType    | string      | 是   | 版本管理方式    | auto/manual                      |     |
| desc           | string      | 否   | 默认更新描述    | 最多200字符                          |     |
| es6            | boolean     | 否   | ES6转ES5   | 默认true                           |     |
| es7            | boolean     | 否   | 增强编译      | 默认true                           |     |
| minifyJS       | boolean     | 否   | 压缩JS      | 默认true                           |     |
| minifyWXML     | boolean     | 否   | 压缩WXML    | 默认true                           |     |
| minifyWXSS     | boolean     | 否   | 压缩WXSS    | 默认true                           |     |
| minify         | boolean     | 否   | 压缩所有      | 默认false                          |     |
| codeProtect    | boolean     | 否   | 代码保护      | 默认false                          |     |
| autoPrefixWXSS | boolean     | 否   | 样式补全      | 默认true                           |     |
| **预览配置**       |             |     |           |                                  |     |
| qrcodeFormat   | string      | 否   | 二维码格式     | image/base64，默认image             |     |
| qrcodeSize     | number      | 否   | 二维码尺寸     | 默认200                            |     |
| pagePath       | string      | 否   | 预览页面路径    | 如：pages/index/index              |     |
| searchQuery    | string      | 否   | 启动参数      | 如：id=123&type=1                  |     |
| scene          | number      | 否   | 场景值       | 默认1011                           |     |
| **通知配置**       |             |     |           |                                  |     |
| notify         | boolean     | 否   | 开启通知      | 默认false                          |     |
| notifyType     | string      | 否   | 通知类型      | wechat/dingtalk/email            |     |
| notifyWebhook  | string      | 否   | Webhook地址 | 机器人webhook                       |     |
| notifyEmails   | array       | 否   | 邮件列表      | 接收通知的邮箱                          |     |
| notifyEvents   | array       | 否   | 通知事件      | [start,success,fail]             |     |

  

**Webhook URL生成规则**：

```

https://domain.com/api/v1/webhook/miniprogram/{id}/{token}

```

其中token为系统自动生成的32位随机字符串

  

#### 3.4.3 编辑小程序

**功能描述**：修改小程序配置

  

**接口定义**：

- **URL**: PUT /api/v1/miniprograms/{id}

- **权限**: miniprogram:update

- **业务规则**：

  - 修改Git配置后需要重新验证仓库访问权限

  - 修改构建配置后建议执行一次测试构建

  

#### 3.4.4 删除小程序

**功能描述**：删除小程序配置

  

**接口定义**：

- **URL**: DELETE /api/v1/miniprograms/{id}

- **权限**: miniprogram:delete

- **业务规则**：

  - 删除前确认是否保留构建历史

  - 删除后webhook自动失效

  

#### 3.4.5 小程序上传

**功能描述**：执行小程序代码上传到微信管理后台

  

**接口定义**：

- **URL**: POST /api/v1/miniprograms/{id}/upload

- **权限**: miniprogram:upload

- **请求参数**：

  

| 字段 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| version | string | 否 | 版本号，不传则自动递增 |
| desc | string | 否 | 更新描述 |
| branch | string | 否 | 指定分支 |
| commitId | string | 否 | 指定commit |

  

**上传流程**：

```

1. 前置检查

   ├── 验证用户权限

   ├── 检查小程序配置完整性

   ├── 检查并发构建限制（最多3个）

   └── 检查磁盘空间（需要>2GB）

  

2. 任务初始化

   ├── 创建构建任务记录

   ├── 生成任务ID（UUID）

   ├── 加入Redis队列

   └── 发送开始通知（可选）

  

3. 代码准备

   ├── 创建工作目录 /tmp/build/{taskId}

   ├── Git认证（SSH/HTTPS/Token）

   ├── 克隆或拉取代码

   ├── 切换到指定分支/commit

   └── 记录Git信息（commit hash、author、message）

  

4. 依赖处理（可选）

   ├── 检测package.json

   ├── 检查缓存（node_modules）

   ├── 执行安装命令（npm/yarn/pnpm）

   ├── 缓存依赖

   └── 输出安装日志

  

5. 代码构建

   ├── uni-app项目

   │   ├── 执行构建命令

   │   ├── 监控构建进度

   │   └── 更新项目路径到输出目录

   ├── 原生项目

   │   └── 执行自定义构建命令（如配置）

   └── 记录构建日志

  

6. 代码上传

   ├── 调用miniprogram-ci.upload()

   ├── 监控上传进度

   ├── 处理上传结果

   └── 获取上传包大小信息

  

7. 后置处理

   ├── 更新构建状态

   ├── 保存构建产物（可选）

   ├── 发送成功通知

   ├── 清理临时文件

   └── 更新版本号（如自动管理）

  

8. 异常处理

   ├── Git异常：重试3次，记录错误

   ├── 依赖安装失败：清缓存重试

   ├── 构建失败：保存日志，通知开发者

   ├── 上传失败：检查密钥，重试1次

   └── 超时处理：30分钟后强制终止

```

  

**响应示例**：

```json

{

  "code": 200,

  "message": "上传任务已创建",

  "data": {

    "taskId": "550e8400-e29b-41d4-a716-446655440000",

    "status": "pending",

    "position": 2,

    "estimatedTime": 180,

    "websocket": "wss://domain.com/ws/build/550e8400"

  }

}

```

  

#### 3.4.6 小程序预览

**功能描述**：生成小程序预览二维码

  

**接口定义**：

- **URL**: POST /api/v1/miniprograms/{id}/preview

- **权限**: miniprogram:preview

- **请求参数**：

  

| 字段 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| branch | string | 否 | 指定分支 |
| pagePath | string | 否 | 预览页面 |
| searchQuery | string | 否 | 页面参数 |
| scene | number | 否 | 场景值 |
| expireTime | number | 否 | 过期时间(分钟)，默认30 |

  

**预览流程**：

与上传流程类似，但第6步改为：

```

6. 生成预览

   ├── 调用miniprogram-ci.preview()

   ├── 获取二维码数据

   ├── 上传二维码到对象存储

   ├── 生成访问链接

   └── 设置过期时间

```

  

**响应示例**：

```json

{

  "code": 200,

  "message": "预览二维码生成成功",

  "data": {

    "qrcodeUrl": "https://cdn.domain.com/qrcode/xxx.png",

    "expireTime": "2024-01-01 12:30:00",

    "pagePath": "pages/index/index",

    "version": "1.0.0-preview.20240101103000"

  }

}

```

  

### 3.5 构建任务模块

  

#### 3.5.1 任务队列管理

**功能描述**：管理和监控构建任务队列

  

**数据模型**：

```javascript

BuildTask = {

  id: string,              // 任务ID (UUID)

  appId: number,           // 小程序ID

  type: string,            // 任务类型: upload/preview

  status: string,          // 状态: pending/running/success/failed/cancelled

  priority: number,        // 优先级: 1-低 2-中 3-高

  retryCount: number,      // 重试次数

  progress: number,        // 进度: 0-100

  // Git信息

  branch: string,          // 分支

  commitId: string,        // Commit ID

  commitMessage: string,   // Commit消息

  commitAuthor: string,    // Commit作者

  // 构建信息

  version: string,         // 版本号

  description: string,     // 描述

  buildLog: text,         // 构建日志

  errorMessage: string,    // 错误信息

  // 时间信息

  createTime: datetime,    // 创建时间

  startTime: datetime,     // 开始时间

  endTime: datetime,       // 结束时间

  duration: number,        // 耗时(秒)

  // 操作信息

  operator: string,        // 操作人

  triggerType: string,     // 触发方式: manual/webhook/scheduled

  // 结果信息

  qrcodeUrl: string,       // 预览二维码

  packageSize: object,     // 包大小信息

}

```

  

#### 3.5.2 构建历史

**功能描述**：查询构建历史记录

  

**接口定义**：

- **URL**: GET /api/v1/build/history

- **权限**: build:read

- **请求参数**：

  

| 字段 | 类型 | 必填 | 描述 |
| --- | --- | --- | --- |
| appId | number | 否 | 小程序ID |
| type | string | 否 | 任务类型 |
| status | string | 否 | 状态筛选 |
| startDate | date | 否 | 开始日期 |
| endDate | date | 否 | 结束日期 |
| page | number | 否 | 页码 |
| pageSize | number | 否 | 每页数量 |

  

#### 3.5.3 任务详情

**功能描述**：查看任务详细信息和实时日志

  

**接口定义**：

- **URL**: GET /api/v1/build/tasks/{taskId}

- **权限**: build:read

- **WebSocket**: wss://domain.com/ws/build/{taskId}

  

**WebSocket消息格式**：

```json

{

  "type": "log",           // log/progress/status/complete

  "timestamp": 1234567890,

  "data": {

    "level": "info",       // info/warning/error

    "message": "正在安装依赖...",

    "progress": 30,

    "status": "running"

  }

}

```

  

#### 3.5.4 任务控制

**功能描述**：取消或重试构建任务

  

**取消任务**：

- **URL**: POST /api/v1/build/tasks/{taskId}/cancel

- **权限**: build:cancel

  
**重试任务**：

- **URL**: POST /api/v1/build/tasks/{taskId}/retry
- **权限**: build:retry
- **限制**: 最多重试3次，失败任务才能重试

### 3.6 Webhook模块

#### 3.6.1 Webhook接收

**功能描述**：接收Git仓库的推送事件，触发自动构建

**接口定义**：

- **URL**: POST /api/v1/webhook/miniprogram/{id}/{token}
- **认证**: 基于token验证
- **支持平台**: GitHub、GitLab、Gitee、Azure DevOps

**请求处理流程**：

```
1. 验证Webhook
   ├── 校验token有效性
   ├── 验证请求来源IP
   ├── 校验签名（如配置）
   └── 解析平台类型

2. 解析推送事件
   ├── 提取分支信息
   ├── 提取commit信息
   ├── 检查是否为目标分支
   └── 过滤无效推送（如删除分支）

3. 触发构建
   ├── 检查自动构建开关
   ├── 检查构建队列状态
   ├── 创建构建任务
   └── 返回响应

4. 异常处理
   ├── token无效：返回401
   ├── 小程序未找到：返回404
   ├── 自动构建关闭：返回200但不处理
   └── 系统异常：返回500并记录日志
```

#### 3.6.2 支持的平台格式

**GitHub格式**：

```json
{
  "ref": "refs/heads/main",
  "commits": [{
    "id": "7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b",
    "message": "fix: 修复登录bug",
    "author": {
      "name": "张三",
      "email": "zhangsan@example.com"
    }
  }],
  "repository": {
    "full_name": "company/project"
  }
}
```

**GitLab格式**：

```json
{
  "ref": "refs/heads/main",
  "commits": [{
    "id": "7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b",
    "message": "fix: 修复登录bug",
    "author": {
      "name": "张三",
      "email": "zhangsan@example.com"
    }
  }],
  "project": {
    "path_with_namespace": "company/project"
  }
}
```

### 3.7 通知模块

#### 3.7.1 通知配置

**支持的通知方式**：

- 企业微信机器人
- 钉钉机器人
- 邮件通知
- 短信通知（可扩展）

**通知事件**：

- build_start：构建开始
- build_success：构建成功
- build_failed：构建失败
- upload_success：上传成功
- preview_success：预览成功

#### 3.7.2 企业微信通知

**消息模板**：

```json
{
  "msgtype": "markdown",
  "markdown": {
    "content": "## 📦 小程序构建通知\n\n**项目名称**: {{appName}}\n**构建类型**: {{buildType}}\n**构建状态**: <font color=\"{{statusColor}}\">{{status}}</font>\n**分支**: {{branch}}\n**版本号**: {{version}}\n**操作人**: {{operator}}\n**耗时**: {{duration}}秒\n\n{{#if errorMessage}}**错误信息**: {{errorMessage}}\n{{/if}}{{#if qrcodeUrl}}**预览二维码**: ![preview]({{qrcodeUrl}})\n{{/if}}\n**时间**: {{timestamp}}"
  }
}
```

#### 3.7.3 钉钉通知

**消息模板**：

```json
{
  "msgtype": "actionCard",
  "actionCard": {
    "title": "小程序构建通知",
    "text": "![screenshot](https://cdn.domain.com/logo.png)\n\n### 📦 {{appName}} 构建{{status}}\n\n- **构建类型**: {{buildType}}\n- **分支**: {{branch}}\n- **版本**: {{version}}\n- **操作人**: {{operator}}\n- **耗时**: {{duration}}秒\n\n{{#if qrcodeUrl}}![二维码]({{qrcodeUrl}})\n{{/if}}",
    "btnOrientation": "0",
    "singleTitle": "查看详情",
    "singleURL": "{{detailUrl}}"
  }
}
```

#### 3.7.4 邮件通知

**邮件模板**：

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>小程序构建通知</title>
</head>
<body style="font-family: Arial, sans-serif; margin: 0; padding: 20px;">
  <div style="max-width: 600px; margin: 0 auto;">
    <h2 style="color: #333;">📦 小程序构建通知</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <tr>
        <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>项目名称</strong></td>
        <td style="padding: 8px; border-bottom: 1px solid #eee;">{{appName}}</td>
      </tr>
      <tr>
        <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>构建状态</strong></td>
        <td style="padding: 8px; border-bottom: 1px solid #eee; color: {{statusColor}};">{{status}}</td>
      </tr>
      <tr>
        <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>构建类型</strong></td>
        <td style="padding: 8px; border-bottom: 1px solid #eee;">{{buildType}}</td>
      </tr>
      <tr>
        <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>分支</strong></td>
        <td style="padding: 8px; border-bottom: 1px solid #eee;">{{branch}}</td>
      </tr>
    </table>
    {{#if qrcodeUrl}}
    <div style="margin-top: 20px; text-align: center;">
      <p><strong>预览二维码</strong></p>
      <img src="{{qrcodeUrl}}" alt="预览二维码" style="max-width: 200px;">
    </div>
    {{/if}}
  </div>
</body>
</html>
```

### 3.8 系统配置模块

#### 3.8.1 系统设置

**功能描述**：管理系统全局配置

**配置项**：

|配置项|类型|描述|默认值|
|---|---|---|---|
|**构建配置**||||
|maxConcurrentBuilds|number|最大并发构建数|3|
|buildTimeout|number|构建超时时间(分钟)|30|
|cleanupDays|number|构建产物保留天数|7|
|logLevel|string|日志级别|info|
|**存储配置**||||
|storageType|string|存储类型：local/oss/cos|local|
|storageConfig|object|存储配置|{}|
|**通知配置**||||
|defaultNotifyEvents|array|默认通知事件|["build_failed"]|
|smtpConfig|object|邮件服务配置|{}|
|**安全配置**||||
|enableCaptcha|boolean|启用验证码|true|
|sessionTimeout|number|会话超时(分钟)|480|
|maxLoginAttempts|number|最大登录尝试次数|5|
|lockoutDuration|number|锁定时长(分钟)|30|

#### 3.8.2 监控统计

**功能描述**：提供系统运行状态监控

**监控指标**：

- 构建成功率：近7天/30天的构建成功率
- 平均构建时长：各项目平均构建耗时
- 系统资源使用：CPU、内存、磁盘使用率
- 队列状态：当前排队任务数量
- 错误统计：常见错误类型统计

**接口定义**：

- **URL**: GET /api/v1/system/metrics
- **权限**: system:monitor

**响应示例**：

```json
{
  "code": 200,
  "data": {
    "buildStats": {
      "totalBuilds": 1250,
      "successRate": 0.925,
      "avgDuration": 158,
      "todayBuilds": 45
    },
    "systemStats": {
      "cpuUsage": 0.35,
      "memoryUsage": 0.68,
      "diskUsage": 0.42,
      "uptime": 864000
    },
    "queueStats": {
      "pendingTasks": 3,
      "runningTasks": 2,
      "completedToday": 43
    }
  }
}
```

## 4. 非功能性需求

### 4.1 性能要求

#### 4.1.1 响应时间

- **页面加载时间**: 首屏 < 2秒，后续页面 < 1秒
- **API响应时间**:
    - 查询接口 < 500ms
    - 创建/更新接口 < 1秒
    - 复杂查询接口 < 2秒
- **构建任务响应**: 任务创建响应 < 200ms
- **实时日志延迟**: < 100ms

#### 4.1.2 吞吐量

- **并发用户数**: 支持100个用户同时在线
- **API并发**: 支持每秒500个API请求
- **构建并发**: 支持最多3个任务同时构建
- **队列容量**: 支持200个任务排队

#### 4.1.3 资源限制

- **单个构建内存限制**: 2GB
- **单个构建磁盘限制**: 5GB
- **构建产物总存储**: 100GB（可配置自动清理）
- **日志文件大小限制**: 单文件最大50MB

### 4.2 安全要求

#### 4.2.1 身份认证

- **密码策略**: 8-20位，包含大小写字母、数字
- **会话管理**: JWT Token，支持刷新机制
- **多因素认证**: 支持邮件/短信二次验证（可选）
- **单点登录**: 支持LDAP/OAuth2集成（可扩展）

#### 4.2.2 数据保护

- **传输加密**: 全站HTTPS，TLS 1.2+
- **存储加密**: 敏感数据（密钥、密码）AES-256加密
- **数据脱敏**: 日志中自动脱敏敏感信息
- **备份加密**: 数据库备份文件加密存储

#### 4.2.3 访问控制

- **权限控制**: 基于RBAC的细粒度权限控制
- **IP白名单**: 支持管理员IP访问限制
- **API限流**: 防止接口滥用，限制单用户请求频率
- **操作审计**: 记录所有关键操作日志

#### 4.2.4 安全防护

- **SQL注入防护**: 使用ORM参数化查询
- **XSS防护**: 前端输入过滤和输出转义
- **CSRF防护**: 使用CSRF Token验证
- **文件上传安全**: 限制文件类型和大小，病毒扫描

### 4.3 可靠性要求

#### 4.3.1 系统可用性

- **目标可用性**: 99.9%（年宕机时间 < 8.76小时）
- **故障检测**: 5分钟内检测到系统故障
- **故障恢复**: 30分钟内恢复服务
- **数据一致性**: 确保构建任务状态的最终一致性

#### 4.3.2 容错机制

- **构建失败重试**: 自动重试最多3次，指数退避
- **网络异常处理**: Git操作支持断点续传
- **服务降级**: 核心功能优先，非核心功能可降级
- **限流熔断**: 防止系统过载，支持熔断保护

#### 4.3.3 数据备份

- **数据库备份**:
    - 全量备份：每日凌晨2点
    - 增量备份：每小时
    - 备份保留：30天
- **文件备份**: 构建产物和日志文件备份
- **恢复验证**: 定期验证备份数据完整性

### 4.4 可扩展性要求

#### 4.4.1 架构可扩展性

- **微服务架构**: 支持服务独立部署和扩容
- **水平扩展**: 支持多实例负载均衡
- **数据库分离**: 读写分离，支持分库分表
- **缓存层**: Redis集群支持

#### 4.4.2 功能可扩展性

- **插件机制**: 支持自定义构建插件
- **通知扩展**: 支持新增通知方式
- **存储扩展**: 支持多种对象存储
- **认证扩展**: 支持多种认证方式

### 4.5 可维护性要求

#### 4.5.1 代码质量

- **代码注释**: 关键代码注释覆盖率 > 50%
- **单元测试**: 核心模块测试覆盖率 > 70%
- **集成测试**: 主要业务流程集成测试
- **代码规范**: 统一的编码规范和ESLint配置

#### 4.5.2 文档要求

- **API文档**: Swagger/OpenAPI自动生成
- **部署文档**: 详细的部署和配置说明
- **运维文档**: 监控、日志、故障处理手册
- **用户手册**: 功能使用说明和FAQ

#### 4.5.3 监控告警

- **应用监控**: APM性能监控
- **基础设施监控**: 服务器资源监控
- **业务监控**: 构建成功率、失败告警
- **日志聚合**: 统一日志收集和分析

## 5. 接口规范

### 5.1 RESTful API设计规范

#### 5.1.1 URL设计

- **版本控制**: /api/v1/
- **资源命名**: 使用复数名词，如 /users、/roles
- **层级关系**: /users/{id}/roles
- **查询参数**: ?page=1&pageSize=10&keyword=admin

#### 5.1.2 HTTP方法

- **GET**: 查询资源
- **POST**: 创建资源
- **PUT**: 完整更新资源
- **PATCH**: 部分更新资源
- **DELETE**: 删除资源

#### 5.1.3 统一响应格式

```json
{
  "code": 200,          // 业务状态码
  "message": "success", // 响应消息
  "data": null,         // 响应数据
  "timestamp": 1234567890, // 时间戳
  "traceId": "xxx"      // 链路追踪ID
}
```

#### 5.1.4 分页格式

```json
{
  "code": 200,
  "data": {
    "list": [],           // 数据列表
    "total": 100,         // 总数量
    "page": 1,            // 当前页
    "pageSize": 10,       // 每页数量
    "totalPages": 10      // 总页数
  }
}
```

### 5.2 错误码定义

#### 5.2.1 HTTP状态码

- **200**: 成功
- **201**: 创建成功
- **400**: 请求参数错误
- **401**: 未认证
- **403**: 无权限
- **404**: 资源不存在
- **409**: 资源冲突
- **422**: 参数验证失败
- **500**: 服务器内部错误

#### 5.2.2 业务错误码

|错误码|描述|HTTP状态码|
|---|---|---|
|200|成功|200|
|10001|参数验证失败|422|
|10002|用户名或密码错误|401|
|10003|用户已被禁用|403|
|10004|验证码错误|400|
|10005|Token已过期|401|
|20001|用户不存在|404|
|20002|用户名已存在|409|
|20003|邮箱已被使用|409|
|30001|角色不存在|404|
|30002|角色名已存在|409|
|30003|系统角色不可删除|403|
|40001|小程序不存在|404|
|40002|AppID已存在|409|
|40003|Git仓库访问失败|400|
|40004|私钥格式错误|400|
|50001|构建任务创建失败|500|
|50002|构建队列已满|429|
|50003|构建任务不存在|404|
|50004|构建任务无法取消|400|
|60001|系统配置错误|500|
|60002|存储服务异常|500|
|60003|通知发送失败|500|

### 5.3 WebSocket规范

#### 5.3.1 连接认证

```javascript
// 连接URL包含token
wss://domain.com/ws/build/{taskId}?token=jwt_token
```

#### 5.3.2 消息格式

```json
{
  "type": "log",                    // 消息类型
  "timestamp": 1234567890,          // 时间戳
  "data": {
    "level": "info",                // 日志级别
    "message": "正在安装依赖...",      // 消息内容
    "progress": 30,                 // 进度百分比
    "phase": "install"              // 当前阶段
  }
}
```

#### 5.3.3 消息类型

- **log**: 构建日志
- **progress**: 进度更新
- **status**: 状态变更
- **error**: 错误信息
- **complete**: 构建完成

## 6. 数据库设计

### 6.1 用户表 (users)

|字段|类型|长度|约束|描述|
|---|---|---|---|---|
|id|INT||PK, AUTO_INCREMENT|主键|
|username|VARCHAR|50|UNIQUE, NOT NULL|用户名|
|password|VARCHAR|255|NOT NULL|加密密码|
|email|VARCHAR|100|UNIQUE, NOT NULL|邮箱|
|phone|VARCHAR|20||手机号|
|real_name|VARCHAR|50||真实姓名|
|avatar|VARCHAR|255||头像URL|
|role_id|INT||FK, NOT NULL|角色ID|
|status|TINYINT||DEFAULT 1|状态：0-禁用 1-启用|
|last_login_time|DATETIME|||最后登录时间|
|last_login_ip|VARCHAR|45||最后登录IP|
|created_at|DATETIME||DEFAULT NOW()|创建时间|
|updated_at|DATETIME||ON UPDATE NOW()|更新时间|
|created_by|VARCHAR|50||创建人|

### 6.2 角色表 (roles)

|字段|类型|长度|约束|描述|
|---|---|---|---|---|
|id|INT||PK, AUTO_INCREMENT|主键|
|name|VARCHAR|50|UNIQUE, NOT NULL|角色名称|
|code|VARCHAR|50|UNIQUE, NOT NULL|角色代码|
|description|TEXT|||角色描述|
|permissions|JSON|||权限列表|
|status|TINYINT||DEFAULT 1|状态：0-禁用 1-启用|
|is_system|BOOLEAN||DEFAULT 0|是否系统角色|
|created_at|DATETIME||DEFAULT NOW()|创建时间|
|updated_at|DATETIME||ON UPDATE NOW()|更新时间|

### 6.3 小程序表 (miniprograms)

| 字段              | 类型       | 长度  | 约束                    | 描述                   |
| --------------- | -------- | --- | --------------------- | -------------------- |
| id              | INT      |     | PK, AUTO_INCREMENT    | 主键                   |
| name            | VARCHAR  | 100 | NOT NULL              | 小程序名称                |
| app_id          | VARCHAR  | 50  | UNIQUE, NOT NULL      | 小程序AppID             |
| private_key     | TEXT     |     | NOT NULL              | 加密的私钥                |
| app_type        | ENUM     |     | NOT NULL              | 项目类型：uniapp,native   |
| git_url         | VARCHAR  | 500 | NOT NULL              | Git仓库地址              |
| branch          | VARCHAR  | 100 | DEFAULT 'master'      | 默认分支                 |
| git_auth_type   | ENUM     |     | NOT NULL              | 认证类型：ssh,https,token |
| git_credential  | TEXT     |     |                       | 加密的Git凭据             |
| install         | BOOLEAN  |     | DEFAULT 1             | 是否安装依赖               |
| install_command | VARCHAR  | 200 | DEFAULT 'npm install' | 安装命令                 |
| build_command   | VARCHAR  | 200 |                       | 构建命令                 |
| output_path     | VARCHAR  | 200 |                       | 输出目录                 |
| npm             | BOOLEAN  |     | DEFAULT 0             | 启用npm构建              |
| auto_build      | BOOLEAN  |     | DEFAULT 0             | 自动构建                 |
| webhook_url     | VARCHAR  | 500 |                       | Webhook地址            |
| webhook_token   | VARCHAR  | 64  |                       | Webhook Token        |
| build_timeout   | INT      |     | DEFAULT 30            | 构建超时(分钟)             |
| version         | VARCHAR  | 20  | DEFAULT '1.0.0'       | 当前版本                 |
| version_type    | ENUM     |     | DEFAULT 'auto'        | 版本类型：auto,manual     |
| description     | VARCHAR  | 500 |                       | 默认描述                 |
| compile_config  | JSON     |     |                       | 编译配置                 |
| preview_config  | JSON     |     |                       | 预览配置                 |
| notify_config   | JSON     |     |                       | 通知配置                 |
| status          | TINYINT  |     | DEFAULT 1             | 状态：0-停用 1-启用         |
| created_at      | DATETIME |     | DEFAULT NOW()         | 创建时间                 |
| updated_at      | DATETIME |     | ON UPDATE NOW()       | 更新时间                 |
| created_by      | VARCHAR  | 50  |                       | 创建人                  |

### 6.4 构建任务表 (build_tasks)

|字段|类型|长度|约束|描述|
|---|---|---|---|---|
|id|VARCHAR|36|PK|任务ID(UUID)|
|app_id|INT||FK, NOT NULL|小程序ID|
|type|ENUM||NOT NULL|任务类型：upload,preview|
|status|ENUM||NOT NULL|状态：pending,running,success,failed,cancelled|
|priority|TINYINT||DEFAULT 2|优先级：1-低 2-中 3-高|
|retry_count|TINYINT||DEFAULT 0|重试次数|
|progress|TINYINT||DEFAULT 0|进度0-100|
|branch|VARCHAR|100||分支|
|commit_id|VARCHAR|40||Commit ID|
|commit_message|TEXT|||Commit消息|
|commit_author|VARCHAR|100||Commit作者|
|version|VARCHAR|20||版本号|
|description|VARCHAR|500||描述|
|build_config|JSON|||构建配置|
|build_log|LONGTEXT|||构建日志|
|error_message|TEXT|||错误信息|
|result_data|JSON|||结果数据|
|qrcode_url|VARCHAR|500||预览二维码|
|package_info|JSON|||包信息|
|created_at|DATETIME||DEFAULT NOW()|创建时间|
|started_at|DATETIME|||开始时间|
|finished_at|DATETIME|||结束时间|
|duration|INT|||耗时(秒)|
|operator|VARCHAR|50||操作人|
|trigger_type|ENUM||NOT NULL|触发类型：manual,webhook,scheduled|

### 6.5 系统配置表 (system_configs)

|字段|类型|长度|约束|描述|
|---|---|---|---|---|
|id|INT||PK, AUTO_INCREMENT|主键|
|key|VARCHAR|100|UNIQUE, NOT NULL|配置键|
|value|TEXT|||配置值|
|type|ENUM||DEFAULT 'string'|值类型：string,number,boolean,json|
|description|VARCHAR|200||描述|
|category|VARCHAR|50||分类|
|is_public|BOOLEAN||DEFAULT 0|是否公开|
|created_at|DATETIME||DEFAULT NOW()|创建时间|
|updated_at|DATETIME||ON UPDATE NOW()|更新时间|

### 6.6 操作日志表 (audit_logs)

|字段|类型|长度|约束|描述|
|---|---|---|---|---|
|id|BIGINT||PK, AUTO_INCREMENT|主键|
|user_id|INT|||用户ID|
|username|VARCHAR|50||用户名|
|action|VARCHAR|100|NOT NULL|操作行为|
|resource_type|VARCHAR|50||资源类型|
|resource_id|VARCHAR|100||资源ID|
|ip_address|VARCHAR|45||IP地址|
|user_agent|VARCHAR|500||用户代理|
|request_data|JSON|||请求数据|
|response_data|JSON|||响应数据|
|created_at|DATETIME||DEFAULT NOW()|创建时间|

## 7. MVP开发方案
### MVP核心思想
MVP的目标是以最小的成本和最短的时间，构建一个包含核心功能、能够解决用户最痛点问题的可用产品。根据您的文档，最核心的痛点是：**替代手动登录后台、手动上传代码的繁琐流程**。

因此，MVP版本将专注于实现以下用户故事：
> “作为一名开发人员，我希望能在一个Web界面上配置我的小程序信息，然后通过点击一个按钮，就能自动完成代码的拉取、构建和上传，并能看到本次上传的结果。”

---

### 第一步：最小可行性产品（MVP）开发方案

此阶段的目标是快速上线核心功能，验证整个自动化流程的可行性。我们将简化或省略所有非核心功能。

#### 1. MVP范围定义 (Scope)

| 模块        | 包含功能                                                | 简化/排除功能                                             |
| :-------- | :-------------------------------------------------- | :-------------------------------------------------- |
| **认证**    | - 用户名/密码登录<br>- 基于JWT的简单认证                          | - 排除：注册、忘记密码、Token刷新、登录失败锁定、验证码                     |
| **小程序管理** | - **新增**小程序（仅包含核心字段）<br>- **列表**展示已配置的小程序           | - 排除：编辑、删除、复杂的Git/编译/预览/通知配置，仅支持最常用场景               |
| **核心构建**  | - 手动触发**上传**功能<br>- 支持`uni-app`的默认构建流程              | - 排除：**预览**功能、Webhook自动构建、并发构建限制、参数化构建（指定分支/commit） |
| **构建历史**  | - 展示小程序关联的构建**历史列表**（状态、版本、耗时）<br>- 查看单次构建的**完整日志** | - 排除：实时日志（WebSocket）、任务控制（取消/重试）                    |
| **用户/角色** | - 系统预置一个管理员账户                                       | - 排除：完整用户管理、RBAC权限控制                                |
| **系统**    | - 核心配置通过文件管理                                        | - 排除：Web界面的系统配置、监控统计模块                              |

#### 2. MVP技术栈简化

- **后端**: 保持NestJS + Prisma + MySQL。
- **任务处理**: **暂时不使用Redis和RabbitMQ**。构建任务采用**同步处理**或简单的**异步`Promise`**。API接口会等待构建完成后再返回结果，这在低并发的MVP阶段是可接受的。
- **前端**: 保持Vue3 + Vite + Element Plus。
- **部署**: 保持Docker + PM2，便于环境统一和基础运维。

#### 3. MVP数据库设计（精简版）

**users表**:
- `id`, `username`, `password` (只需这三个核心字段)

**miniprograms表**:
- `id`, `name`, `appId`, `privateKey` (加密存储), `gitUrl`
- (其他如`appType`, `buildCommand`, `outputPath`等可以暂时硬编码在后端逻辑中)

**build_tasks表**:
- `id`, `app_id`, `type` (默认为'upload'), `status`, `version`, `build_log` (存储完整日志), `created_at`, `duration`

#### 4. MVP开发步骤 (建议4周完成)

**第一周：环境搭建与后端核心**
1.  **项目初始化**: 创建NestJS后端和Vue3前端项目骨架。
2.  **数据库设计**: 创建上述3张精简版数据表。
3.  **核心CI封装**: 在后端封装一个核心服务，该服务能接收参数（Git地址、AppID、私钥等），并使用`miniprogram-ci`和`shelljs`等工具在本地临时目录中完成`git clone` -> `npm install` -> `npm run build:mp-weixin` -> `ci.upload()` 的完整流程。
4.  **API开发(1)**: 实现用户登录认证接口。

**第二周：后端API与前端页面**
1.  **API开发(2)**:
    *   `POST /api/v1/miniprograms`: 创建小程序配置。
    *   `GET /api/v1/miniprograms`: 获取小程序列表。
    *   `POST /api/v1/miniprograms/{id}/upload`: 手动触发上传，此接口将**同步调用**第一周封装的核心CI服务。
    *   `GET /api/v1/miniprograms/{id}/tasks`: 获取指定小程序的构建历史。
    *   `GET /api/v1/build/tasks/{taskId}`: 获取单个任务的详情（主要是日志）。
2.  **前端页面(1)**:
    *   开发登录页面。
    *   创建前端路由和导航框架。

**第三周：前端功能实现**
1.  **前端页面(2)**:
    *   **小程序列表页**: 展示所有小程序，并提供“新增”和“上传”按钮。
    *   **新增小程序弹窗/页面**: 包含名称、AppID、私钥文件上传、Git地址等最核心的输入项。
    *   **构建历史页**: 点击小程序列表中的“历史”按钮进入，展示该小程序的所有构建记录。
    *   **构建详情页**: 点击历史记录，可查看本次构建的完整日志文本。

**第四周：联调、测试与部署**
1.  前后端接口联调，修复BUG。
2.  编写Dockerfile，进行容器化部署。
3.  编写一份简单的使用和部署文档。
4.  在测试服务器上部署，并进行完整的流程测试。

---

### 第二步：后续迭代开发方案

在MVP版本成功上线并获得初步反馈后，可以按照以下阶段逐步完善产品功能，持续交付价值。

#### 阶段一：提升核心体验与易用性 (MVP后第1-2个月)

**目标**：解决MVP中的性能瓶颈和体验短板，补全高频功能。

1.  **异步构建与任务队列**:
    *   引入`Redis`和`RabbitMQ`（或仅用Redis作队列）。
    *   将构建上传流程改造为异步任务，API调用后立即返回任务ID，前端通过轮询或WebSocket获取状态。
    *   这是最重要的优化，可以避免API长时等待，并为后续的并发构建打下基础。
2.  **实时构建日志**:
    *   引入`WebSocket`。
    *   后端在执行构建任务的各个阶段，通过WebSocket将日志实时推送到前端，极大提升用户体验。
3.  **小程序预览功能**:
    *   增加“预览”按钮和相关API接口 (`/preview`)。
    *   后端调用`miniprogram-ci.preview()`，将生成的二维码上传到MinIO或直接返回Base64，供测试和产品人员扫码。
4.  **完善小程序管理**:
    *   实现小程序的编辑和删除功能。
    *   将硬编码的构建命令、输出目录等改为在“新增/编辑”页面可配置。

#### 阶段二：实现全面自动化与协作 (第3-4个月)

**目标**：从“手动触发”进化到“自动触发”，并支持团队协作。

1.  **完整的用户与权限管理 (RBAC)**:
    *   实现用户管理、角色管理模块。
    *   为所有API接口增加基于角色的权限校验，实现不同用户拥有不同操作权限（如开发只能上传、测试只能预览）。
2.  **Webhook自动构建**:
    *   实现`POST /api/v1/webhook/miniprogram/{id}/{token}`接口。
    *   支持解析来自GitHub/GitLab/Gitee的推送事件，自动触发对应分支的构建任务。
3.  **通知系统**:
    *   集成企业微信、钉钉机器人通知。
    *   在小程序配置中增加通知配置项。
    *   在任务成功、失败等关键节点发送消息通知。

#### 阶段三：迈向企业级与智能化 (第5-6个月)

**目标**：提供更强的系统管理能力和数据洞察，满足更复杂的企业需求。

1.  **系统配置与监控**:
    *   开发“系统设置”页面，将并发数、超时时间、日志保留期等配置化。
    *   开发“监控统计”仪表盘，使用ECharts将构建成功率、平均耗时、资源使用率等指标可视化。
2.  **增强的安全性**:
    *   增加登录失败锁定、操作审计日志等安全功能。
    *   对存储的密钥、凭据等敏感信息进行更高强度的加密和权限隔离。
3.  **参数化构建**:
    *   在手动触发上传/预览时，允许用户选择分支、填写版本号和更新描述，覆盖默认配置。
4.  **扩展性支持**:
    *   设计插件机制，允许用户自定义构建前后的脚本。
    *   支持更多存储方式（如阿里云OSS、腾讯云COS）。